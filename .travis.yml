language: php

services:
  - docker

sudo: false

env:
  - DOCKER_COMPOSE_VERSION=1.23.2

before_install:
  # Install docker-compose
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker-compose --version
  - docker ps
  - sudo ls
  # Composer stuff
  - composer self-update
  - composer clear-cache

install:
  - travis_retry composer update --no-interaction --no-ansi --no-progress --no-suggest --optimize-autoloader --prefer-stable --dev
  # Start up docker compose
  - docker-compose -f docker-compose.phpunit.yml up -d
  # Fix invalid permissions for bin/install-wp-tests.sh
  - docker-compose -f docker-compose.phpunit.yml run --rm wordpress_phpunit chmod +x bin/install-wp-tests.sh
  # Setup tests suite
  - docker-compose -f docker-compose.phpunit.yml run --rm wordpress_phpunit bin/install-wp-tests.sh wordpress_test root root mysql_test latest true

script:
  - docker-compose -f docker-compose.phpunit.yml run --rm wordpress_phpunit vendor/bin/phpunit

after_script:
  - docker-compose down --remove-orphans
